{% extends 'layouts/page.njk' %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% block pageTitle %}Upload Policy Document{% endblock %}

{% block bodyAttributes %}{% if processingId %} data-processing-id="{{ processingId }}"{% endif %}{% endblock %}

{% block content %}
<h1 class="govuk-heading-m">Upload a Document to Generate AI-Powered Insights</h1>
<form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data" onsubmit="document.getElementById('submitButton').disabled = true; document.getElementById('loadingMessage').style.display = 'block';">
  <div class="govuk-form-group">
    <label class="govuk-label" for="analysisType">
      Prompt analysis type
    </label>
    <select class="govuk-select" id="analysisType" name="analysisType" required style="padding: 8px 12px; border: 2px solid #0b0c0c; border-radius: 4px; font-size: 16px; background: white; min-width: 200px;" oninvalid="this.setCustomValidity('Please select an analysis type')" oninput="this.setCustomValidity('')">
      <option value="">Select analysis type</option>
      <option value="red" {% if analysisType == 'red' %}selected{% endif %}>ðŸ“• Red book</option>
      <option value="green" {% if analysisType == 'green' %}selected{% endif %}>ðŸ“— Green book</option>
      <option value="red-investment" {% if analysisType == 'red-investment' %}selected{% endif %}>ðŸ“Š Red Investment Committee Briefing</option>
      <option value="executive" {% if analysisType == 'executive' %}selected{% endif %}>ðŸ’¼ Executive Briefing</option>
    </select>
  </div>
  <div class="govuk-form-group">
    <label class="govuk-label" for="policyPdf">Select PDF file</label>
    <div class="file-selection-area">
      <input class="govuk-file-upload" id="policyPdf" name="policyPdf" type="file" accept="application/pdf" required>
      <div id="fileSpinner" class="spinner" style="display: none;"></div>
    </div>
  </div>
  {{ govukButton({ text: "Summarise", attributes: { type: "submit", id: "submitButton" } }) }}
  <div id="loadingMessage" class="govuk-inset-text" style="display: none;">
    <div class="spinner" style="display: inline-block; margin-right: 10px;"></div>
    Processing PDF... Please wait...
  </div>
</form>
<div id="fileInfo" style="margin-top:1em; display:none;">
  <strong>Selected file:</strong> <span id="fileName"></span>
</div>

<!-- Upload History Table -->
{% if uploads and uploads.length > 0 %}
<div class="govuk-form-group" style="margin-top: 2em;">
  <h2 class="govuk-heading-m">Upload History</h2>
  <table class="govuk-table" id="uploadHistoryTable">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header">Filename</th>
        <th class="govuk-table__header">Analysis Type</th>
        <th class="govuk-table__header">Status</th>
        <th class="govuk-table__header">Timestamp</th>
        <th class="govuk-table__header">Request ID</th>
        <th class="govuk-table__header">Action</th>
      </tr>
    </thead>
    <tbody class="govuk-table__body" id="uploadHistoryBody">
      {% for upload in uploads %}
      <tr class="govuk-table__row">
        <td class="govuk-table__cell">{{ upload.filename }}</td>
        <td class="govuk-table__cell">{{ upload.analysisType }}</td>
        <td class="govuk-table__cell">
          <span class="status-badge status-{{ upload.status }}">{{ upload.status }}</span>
        </td>
        <td class="govuk-table__cell">{{ upload.timestamp | date('DD-MM-YYYY HH:mm') }}</td>
        <td class="govuk-table__cell">{{ upload.requestId }}</td>
        <td class="govuk-table__cell">
          {% if upload.status == 'completed' %}
          <a href="/status/{{ upload.requestId }}" target="_blank" class="govuk-link">View Results</a>
          {% else %}
          <span class="govuk-hint">Processing...</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
.status-badge {
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
}
.status-analyzing { background: #ff9800; color: white; }
.status-completed { background: #00703c; color: white; animation: pulse 2s infinite; }
.status-failed { background: #f44336; color: white; }
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  setInterval(updateUploadHistory, 10000);
  
  async function updateUploadHistory() {
    try {
      const response = await fetch('/upload/status');
      const uploads = await response.json();
      updateHistoryTable(uploads);
    } catch (error) {
      console.error('Failed to update upload history:', error);
    }
  }
  
  function updateHistoryTable(uploads) {
    const tbody = document.getElementById('uploadHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    uploads.forEach(upload => {
      const row = document.createElement('tr');
      row.className = 'govuk-table__row';
      
      const actionCell = upload.status === 'completed'
        ? `<a href="/status/${upload.requestId}" target="_blank" class="govuk-link">View Results</a>`
        : '<span class="govuk-hint">Processing...</span>';
      
      const timestamp = new Date(upload.timestamp).toLocaleString('en-GB', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).replace(',', '');
      
      row.innerHTML = `
        <td class="govuk-table__cell">${upload.filename}</td>
        <td class="govuk-table__cell">${upload.analysisType}</td>
        <td class="govuk-table__cell">
          <span class="status-badge status-${upload.status}">${upload.status}</span>
        </td>
        <td class="govuk-table__cell">${timestamp}</td>
        <td class="govuk-table__cell">${upload.requestId}</td>
        <td class="govuk-table__cell">${actionCell}</td>
      `;
      tbody.appendChild(row);
    });
  }
});
</script>
{% endif %}

{% endblock %}